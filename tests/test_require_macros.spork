; Test macro importing via ns :require
; Tests compile-time macro importing from other modules using :require :refer

(ns tests.test-require-macros
  (:require [tests.test-macro :as tm :refer [my-when]]
            [tests.test-macros :as tms :refer [when unless ->]]))

(print "=== Testing macro import via :require ===\n")

; ============================================================================
; 1. Import macros from test-macro module via :refer
; ============================================================================

(print "--- 1. Import my-when from test-macro via :refer ---")

(def result1 (my-when true 42))
(print "my-when true 42:" result1)
(assert (= result1 42))

(def result1b (my-when false 100))
(print "my-when false 100:" result1b)
(assert (= result1b nil))

(print "✓ Imported my-when macro works\n")

; ============================================================================
; 2. Import macros from test-macros module via :refer
; ============================================================================

(print "--- 2. Import when and unless from test-macros via :refer ---")

(def result2a (when true "yes"))
(print "when true:" result2a)
(assert (= result2a "yes"))

(def result2b (when false "no"))
(print "when false:" result2b)
(assert (= result2b nil))

(def result2c (unless false "correct"))
(print "unless false:" result2c)
(assert (= result2c "correct"))

(def result2d (unless true "wrong"))
(print "unless true:" result2d)
(assert (= result2d nil))

(print "✓ Imported when and unless macros work\n")

; ============================================================================
; 3. Import threading macro from test-macros
; ============================================================================

(print "--- 3. Import -> threading macro from test-macros ---")

(def result3 (-> 5 (+ 3)))
(print "-> 5 (+ 3):" result3)
(assert (= result3 8))

(print "✓ Imported threading macro works\n")

; ============================================================================
; 4. Use imported macros together
; ============================================================================

(print "--- 4. Use imported macros together ---")

(def result4 (my-when true (-> 10 (+ 5))))
(print "my-when true (-> 10 (+ 5)):" result4)
(assert (= result4 15))

(print "✓ Combined imported macros work\n")

; ============================================================================
; 5. Define local macro that uses imported macro
; ============================================================================

(print "--- 5. Local macro using imported macro ---")

(defmacro double-when [test x]
  `(my-when ~test (* 2 ~x)))

(def result5 (double-when true 21))
(print "double-when true 21:" result5)
(assert (= result5 42))

(def result5b (double-when false 21))
(print "double-when false 21:" result5b)
(assert (= result5b nil))

(print "✓ Local macro using imported macro works\n")

; ============================================================================
; 6. Test qualified macro access via :as alias
; ============================================================================

(print "--- 6. Qualified macro access via alias ---")

(def result6 (tm.my-when true 999))
(print "tm.my-when true 999:" result6)
(assert (= result6 999))

(def result6b (tms.when true "aliased"))
(print "tms.when true 'aliased':" result6b)
(assert (= result6b "aliased"))

(print "✓ Qualified macro access via alias works\n")

; ============================================================================
; 7. Test :refer :all imports all macros
; ============================================================================

(print "--- 7. Test :refer :all imports all macros ---")

; We need a separate ns form to test :refer :all, so we'll just verify
; that the macros we imported via :refer work (they came from the module)
; The actual :refer :all test would require a fresh namespace context

; For now, verify the macros from test-macros work (when, unless, ->)
(def result7a (when true "all-test"))
(print "when via :refer:" result7a)
(assert (= result7a "all-test"))

(def result7b (unless false "all-unless"))
(print "unless via :refer:" result7b)
(assert (= result7b "all-unless"))

(print "✓ :refer correctly imports macros\n")

; ============================================================================
; Summary
; ============================================================================

(print "=== All :require Macro Tests Passed! ===")
(print "✓ Import single macro via :refer")
(print "✓ Import multiple macros via :refer")
(print "✓ Import threading macro")
(print "✓ Combined imported macros")
(print "✓ Local macro using imported macro")
(print "✓ Qualified macro access via :as alias")
(print "✓ :refer imports macros from modules")
(print "")
